!function(e,t){"function"==typeof define&&define.amd?define(["bluebird","facebook","lodash"],function(e,n,i){return t(e,n,i)}):"object"==typeof module&&module.exports?module.exports=t(require("bluebird"),require("facebook"),require("lodash")):e.FBExplorer=t(e.bluebird,e.facebook,e.lodash)}(this,function(e,t,n){"use strict";var i,r,s,o={types:{EVENT:"event",PAGE:"page",PLACE:"place"},fields:{event:{basic:["id","name"],brief:["category","cover","description","id","end_time","name","place","start_time"],extended:["attending_count","category","cover","description","id","interested_count","end_time","maybe_count","name","place","start_time","type"],full:["attending_count","can_guests_invite","can_viewer_post","category","cover","declined_count","description","end_time","id","interested_count","is_cancelled","is_draft","is_page_owned","is_viewer_admin","maybe_count","name","noreply_count","owner","parent_group","place","start_time","ticket_uri","timezone","type","updated_time"]},page:{basic:["id","name"],brief:["category","cover","description","id","location","name"],extended:["category","contact_address","cover","description","fan_count","featured_video","founded","id","location","name","talking_about_count","website"],full:["about","app_links","best_page","can_checkin","category","category_list","contact_address","cover","description","display_subtext","emails","fan_count","featured_video","founded","general_info","id","impressum","is_community_page","is_verified","link","location","name","overall_star_rating","parent_page","phone","rating_count","start_info","supports_instant_articles","talking_about_count","website","were_here_count"]},place:{basic:["id","name"],brief:["category","description","id","location","name","picture"],extended:["category","description","hours","id","location","name","phone","picture","website"],full:["about","category","category_list","cover","checkins","description","hours","id","is_always_open","is_permanently_closed","is_verified","link","location","name","overall_star_rating","parking","payment_options","phone","photos","picture","price_range","rating_count","restaurant_services","restaurant_specialties","single_line_address","website","workflows"]}},profiles:{BASIC:"basic",BRIEF:"brief",EXTENDED:"extended",FULL:"full"},sort:{DISTANCE:"distance",NAME:"name",TIME:"time"},order:{ASC:"asc",DESC:"desc"}},a={version:"v2.9",profile:o.profiles.BRIEF,since:"now",days:30},c={init:function(n){return r=n.appId,this.config=Object.assign({},a,n),s=new e(function(e,n){t.Event.subscribe("auth.statusChange",function(t){"connected"==t.status?e(!0):n(!1)}.bind(this))}),t.init({appId:this.getAppId(),version:this.config.version}),this.getLoginStatus()},ready:function(){return s},getLoginStatus:function(){return new e(function(e,n){t.getLoginStatus(function(t){t&&t.authResponse&&t.authResponse.accessToken?(this.setToken(t.authResponse.accessToken),e()):n()}.bind(this),!0)}.bind(this))},getToken:function(){return i},setToken:function(e){i=e},getAppId:function(){return r},setAppId:function(e){r=e,this.init({appId:e})},findPlaces:function(e,t){if(e)return this.search(o.types.PLACE,e,t).bind(this).then(function(t){return t=this.sort(t,e.sort,e.order,e.center)})},findPages:function(e,t){if(e)return this.search(o.types.PAGE,e,t).bind(this).then(function(t){return t=this.sort(t,e.sort,e.order,e.center)})},findEvents:function(t,i){if(t){var r=t.until||this.__getDefaultUntilTime(),s=t.since||this.__getDefaultSinceTime();return this.findPlaces({center:t.center,distance:t.distance,fields:"id,events.fields(id).since("+s+").until("+r+").limit(1)"}).bind(this).then(function(n){for(var o=[],a=n.length;a--;)if(n[a].events){var c=this.__searchEventsByPlaceId({placeId:n[a].id,until:r,since:s,profile:t.profile,fields:t.fields},i);o.push(c)}return e.all(o)}).bind(this).then(function(e){return i&&i.apply(null,[[],!1]),this.sort(n.flatten(e),t.sort,t.order,t.center)})}},search:function(i,r,s){if(r){var o=[];return this.ready().bind(this).then(function(){var a="",c=function(){return new e(function(e,c){var d=a||"/search?type="+i+this.__getSearchQuery(i,r);t.api(d,function(t){if(!t||t.error)c(t.error);else{var i=n.xorBy(o,t.data,"id");a=t.paging&&t.paging.next,o=o.concat(i),"function"==typeof s&&s.apply(null,[i,n.isUndefined(a)]),e(a)}}.bind(this))}.bind(this))}.bind(this);return this.__promiseWhile(function(){return n.isUndefined(a)},c,a).bind(this).then(function(e){return o})})}},sort:function(e,t,n,i){return t===o.sort.DISTANCE?e=this.__sortByDistance(e,n,i):t===o.sort.TIME?e=this.__sortByTime(e,n):t===o.sort.NAME&&(e=this.__sortByField(e,t,n)),e},getFieldsFromProfile:function(e,t){if(this.__isTypeValid(e))return t=this.__isProfileValid(t)?t:a.profile,o.fields[e][t].join(",")},__getSearchQuery:function(e,t){var n="";return n+="&q="+(t.keywords||""),n+="&fields="+(t.fields||this.getFieldsFromProfile(e,t.profile)),n+="&accessToken="+this.getToken(),e===o.types.EVENT&&(n+="&since="+t.since,n+="&until="+t.until),t.center&&(n+="&center="+t.center.latitude+","+t.center.longitude),t.center&&(n+="&distance="+t.distance),n},__sortByDistance:function(e,t,n){return e.sort(function(e,i){var r=e&&(e.location||e.place&&e.place.location),s=i&&(i.location||i.place&&i.place.location);if(!r&&!s)return 0;if(!r)return-1;if(!s)return 1;var a=this.__calculateDistance(n,r),c=this.__calculateDistance(n,s);return t===o.order.ASC?a-c:c-a}.bind(this))},__calculateDistance:function(e,t){if(e&&t){var n=e.latitude,i=e.longitude,r=t.latitude,s=t.longitude,o=.017453292519943295,a=.5-Math.cos((r-n)*o)/2+Math.cos(n*o)*Math.cos(r*o)*(1-Math.cos((s-i)*o))/2;return 12742*Math.asin(Math.sqrt(a))}},__sortByTime:function(e,t){return e.sort(function(e,n){var i=new Date(e.start_time),r=new Date(n.start_time);return t===o.order.ASC?i-r:r-i})},__sortByField:function(e,t,i){return n.orderBy(e,[t],[i])},__isProfileValid:function(e){return n.includes(o.profiles,e)},__isTypeValid:function(e){return n.includes(o.types,e)},__searchEventsByPlaceId:function(i,r){if(i&&i.placeId){var s=[];return this.ready().bind(this).then(function(){var a="",c=function(){return new e(function(e,c){var d=a||"/"+i.placeId+"/events?"+this.__getSearchQuery(o.types.EVENT,i);t.api(d,function(t){if(!t||t.error)c(t.error);else{var i=n.xorBy(s,t.data,"id");a=t.paging&&t.paging.next,s=s.concat(i),"function"==typeof r&&r.apply(null,[i,!0]),e(a)}}.bind(this))}.bind(this))}.bind(this);return this.__promiseWhile(function(){return n.isUndefined(a)},c,a).bind(this).then(function(e){return s})})}},__getDefaultSinceTime:function(){return a.since},__getDefaultUntilTime:function(){var e=new Date;return e.setDate(e.getDate()+a.days),e.getFullYear()+"-"+this.__pad(e.getMonth()+1)+"-"+this.__pad(e.getDate())},__pad:function(e){return e<10?"0"+e:""+e},__promiseWhile:e.method(function(e,t,n){return e()?n:t().then(this.__promiseWhile.bind(this,e,t))})};return{init:c.init.bind(c),getAppId:c.getAppId.bind(c),setAppId:c.setAppId.bind(c),findEvents:c.findEvents.bind(c),findPages:c.findPages.bind(c),findPlaces:c.findPlaces.bind(c)}});