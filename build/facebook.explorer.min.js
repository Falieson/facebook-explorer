!function(e,t){"function"==typeof define&&define.amd?define("src/auth",[],t):"object"==typeof exports?module.exports=t():e.Auth=t()}(this,function(){"use strict";var e,t,n={getToken:function(){return e},setToken:function(t){e=t},getAppId:function(){return t},setAppId:function(e){t=e}};return n}),!function(e,t){"function"==typeof define&&define.amd?define("src/dict",[],t):"object"==typeof exports?module.exports=t():e.Dict=t()}(this,function(e){"use strict";var t={types:{EVENT:"event",PAGE:"page",PLACE:"place"},fields:{event:{basic:["id","name"],brief:["category","cover","description","id","end_time","name","place","start_time"],extended:["attending_count","category","cover","description","id","interested_count","end_time","maybe_count","name","place","start_time","type"],full:["attending_count","can_guests_invite","can_viewer_post","category","cover","declined_count","description","end_time","id","interested_count","is_cancelled","is_draft","is_page_owned","is_viewer_admin","maybe_count","name","noreply_count","owner","parent_group","place","start_time","ticket_uri","timezone","type","updated_time"]},page:{basic:["id","name"],brief:["category","cover","description","id","location","name"],extended:["category","contact_address","cover","description","fan_count","featured_video","founded","id","location","name","talking_about_count","website"],full:["about","app_links","best_page","can_checkin","category","category_list","contact_address","cover","description","display_subtext","emails","fan_count","featured_video","founded","general_info","id","impressum","is_community_page","is_verified","link","location","name","overall_star_rating","parent_page","phone","rating_count","start_info","supports_instant_articles","talking_about_count","website","were_here_count"]},place:{basic:["id","name"],brief:["category","description","id","location","name","picture"],extended:["category","description","hours","id","location","name","phone","picture","website"],full:["about","category","category_list","cover","checkins","description","hours","id","is_always_open","is_permanently_closed","is_verified","link","location","name","overall_star_rating","parking","payment_options","phone","photos","picture","price_range","rating_count","restaurant_services","restaurant_specialties","single_line_address","website","workflows"]}},profiles:{BASIC:"basic",BRIEF:"brief",EXTENDED:"extended",FULL:"full"},sort:{DISTANCE:"distance",NAME:"name",TIME:"time"},order:{ASC:"asc",DESC:"desc"}};return t}),!function(e,t){"function"==typeof define&&define.amd?define("src/main",["src/auth","src/dict","bluebird","lodash"],t):"object"==typeof exports?module.exports=t(require("src/auth"),require("src/dict"),require("bluebird"),require("lodash")):e.FBExplorer=t(e.Auth,e.Dict,e.Promise,e._)}(this,function(e,t,n,i){"use strict";var r={version:"v2.9",profile:t.profiles.BRIEF,lowerTimeLimit:"now",timeRangeInDays:30},s=new n(function(e,t){FB.Event.subscribe("auth.statusChange",function(n){"connected"==n.status?e(!0):t(!1)}.bind(this))}),o={init:function(t){return e.setAppId(t.appId),this.config=Object.assign({},r,t),FB.init({appId:e.getAppId(),version:this.config.version}),this.getLoginStatus()},ready:function(){return s},getLoginStatus:function(){return new n(function(t,n){FB.getLoginStatus(function(i){i&&i.authResponse&&i.authResponse.accessToken?(e.setToken(i.authResponse.accessToken),t()):n()}.bind(this),!0)}.bind(this))},findPlaces:function(e,n){if(e)return this.search(t.types.PLACE,e,n).bind(this).then(function(t){var t=this.sort(t,e.sort,e.order,e.center);return t})},findPages:function(e,n){if(e)return this.search(t.types.PAGE,e,n).bind(this).then(function(t){var t=this.sort(t,e.sort,e.order,e.center);return t})},findEvents:function(e,t){if(e){var r=e.until||this.__getDefaultUntilTime(),s=e.since||this.__getDefaultSinceTime();return this.findPlaces({center:e.center,distance:e.distance,fields:"id,events.fields(id).since("+s+").until("+r+").limit(1)"}).bind(this).then(function(i){for(var o=[],a=i.length;a--;)if(i[a].events){var c=this.__searchEventsByPlaceId({placeId:i[a].id,until:r,since:s,profile:e.profile,fields:e.fields},t);o.push(c)}return n.all(o)}).bind(this).then(function(n){return t&&t.apply(null,[[],!1]),this.sort(i.flatten(n),e.sort,e.order,e.center)})}},search:function(e,t,r){if(t){var s=[];return this.ready().bind(this).then(function(){var o="",a=function(){return i.isUndefined(o)},c=function(){return new n(function(n,a){var c=o?o:"/search?type="+e+this.__getSearchQuery(e,t);FB.api(c,function(e){if(!e||e.error)a(e.error);else{var t=i.xorBy(s,e.data,"id");o=e.paging&&e.paging.next,s=s.concat(t),"function"==typeof r&&r.apply(null,[t,i.isUndefined(o)]),n(o)}}.bind(this))}.bind(this))}.bind(this);return this.__promiseWhile(a,c,o).bind(this).then(function(e){return s})})}},sort:function(e,n,i,r){return n===t.sort.DISTANCE?e=this.__sortByDistance(e,i,r):n===t.sort.TIME?e=this.__sortByTime(e,i):n===t.sort.NAME&&(e=this.__sortByField(e,n,i)),e},getFieldsFromProfile:function(e,n){if(this.__isTypeValid(e))return n=this.__isProfileValid(n)?n:defauls.profile,t.fields[e][n].join(",")},__getSearchQuery:function(n,i){var r="";return r+="&q="+(i.keywords||""),r+="&fields="+(i.fields||this.getFieldsFromProfile(n,i.profile)),r+="&accessToken="+e.getToken(),n===t.types.EVENT&&(r+="&since="+i.since,r+="&until="+i.until),i.center&&(r+="&center="+i.center.latitude+","+i.center.longitude),i.center&&(r+="&distance="+i.distance),r},__sortByDistance:function(e,n,i){return e.sort(function(e,r){var s=e&&(e.location||e.place&&e.place.location),o=r&&(r.location||r.place&&r.place.location);if(!s&&!o)return 0;if(!s)return-1;if(!o)return 1;var a=this.__calculateDistance(i,s),c=this.__calculateDistance(i,o);return n===t.order.ASC?a-c:c-a}.bind(this))},__calculateDistance:function(e,t){if(e&&t){var n=e.latitude,i=e.longitude,r=t.latitude,s=t.longitude,o=12742,a=.017453292519943295,c=.5-Math.cos((r-n)*a)/2+Math.cos(n*a)*Math.cos(r*a)*(1-Math.cos((s-i)*a))/2;return o*Math.asin(Math.sqrt(c))}},__sortByTime:function(e,n){return e.sort(function(e,i){var r=new Date(e.start_time),s=new Date(i.start_time);return n===t.order.ASC?r-s:s-r})},__sortByField:function(e,t,n){return i.orderBy(e,[t],[n])},__isProfileValid:function(e){return i.includes(t.profiles,e)},__isTypeValid:function(e){return i.includes(t.types,e)},__searchEventsByPlaceId:function(e,r){if(e&&e.placeId){var s=[];return this.ready().bind(this).then(function(){var o="",a=function(){return i.isUndefined(o)},c=function(){return new n(function(n,a){var c=o?o:"/"+e.placeId+"/events?"+this.__getSearchQuery(t.types.EVENT,e);FB.api(c,function(e){if(!e||e.error)a(e.error);else{var t=i.xorBy(s,e.data,"id");o=e.paging&&e.paging.next,s=s.concat(t),"function"==typeof r&&r.apply(null,[t,!0]),n(o)}}.bind(this))}.bind(this))}.bind(this);return this.__promiseWhile(a,c,o).bind(this).then(function(e){return s})})}},__getDefaultSinceTime:function(){return r.lowerTimeLimit},__getDefaultUntilTime:function(){var e=new Date;return e.setDate(e.getDate()+r.timeRangeInDays),e.getFullYear()+"-"+e.getDate()+"-"+e.getMonth()},__promiseWhile:n.method(function(e,t,n){return e()?n:t().then(this.__promiseWhile.bind(this,e,t))})};return{init:o.init.bind(o),getAppId:e.getAppId,setAppId:e.setAppId,findEvents:o.findEvents.bind(o),findPages:o.findPages.bind(o),findPlaces:o.findPlaces.bind(o)}});